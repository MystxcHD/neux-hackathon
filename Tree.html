<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Skill Tree (ECharts - Readable Text)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    
    <style>
        :root {
            --bg-color: #101010;
            --surface1-color: #1e1e1e;
            --text-primary: #f0f0f0; 
            --text-secondary: #a0a0a0;
            --accent-primary: #e0e0e0;
            --icon-color-1: #f04a94;
            --icon-color-2: #3b82f6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow: hidden; 
        }
        .page-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            position: relative;
        }
        
        /* --- Header --- */
        .page-header {
            padding: 16px 24px;
            background-color: var(--surface1-color);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            z-index: 100; 
            flex-shrink: 0;
        }
        .back-button {
            color: var(--text-primary);
            text-decoration: none;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1; 
        }
        .back-button:hover { background-color: #333; }
        .page-header h1 {
            font-size: 1.25rem;
            font-weight: 500;
        }
        .page-header h1 strong {
            font-weight: 700;
            color: var(--icon-color-2);
        }

        /* --- Tree Visualization --- */
        #tree-container {
            flex-grow: 1; 
            width: 100%;
            z-index: 1;
        }
        .loading-message {
            color: var(--text-secondary);
            font-size: 1.2rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
        }

        /* --- Modal (Unchanged) --- */
        #modal-overlay {
            display: none; 
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #modal-content {
            background-color: var(--surface1-color);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid #333;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        #modal-close {
            position: absolute;
            top: 16px; right: 16px;
            background: none; border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        #modal-close:hover { color: var(--text-primary); }
        #modal-title {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .modal-section { margin-bottom: 24px; }
        .modal-section h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--icon-color-2);
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }
        .problem { margin-bottom: 16px; }
        .problem p { margin-bottom: 8px; font-size: 1.1rem; }
        .problem .solution {
            font-family: monospace;
            background-color: var(--bg-color);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }
        .video-link {
            display: block;
            color: var(--text-secondary);
            text-decoration: none;
            margin-bottom: 8px;
        }
        .video-link:hover { color: var(--accent-primary); }
        
    </style>
</head>
<body>

    <div class="page-container">
        <header class="page-header">
            <a href="index.html" class="back-button" title="Back to Home">&larr;</a>
            <h1>Skill Tree for: <strong id="prompt-title">...</strong></h1>
        </header>
        
        <main id="tree-container">
        </main>
    </div>

    <div id="modal-overlay">
        <div id="modal-content">
            <button id="modal-close" title="Close">&times;</button>
            <h2 id="modal-title">Skill Name</h2>
            
            <div class="modal-section" id="practice-problems">
                <h3>Practice Problems</h3>
            </div>

            <div class="modal-section" id="video-tutorials">
                <h3>Video Tutorials</h3>
            </div>
            
        </div>
    </div>


    <script>
        
        // --- MOCK DATABASE (Unchanged) ---
        const FAKE_SKILL_DB = {
            "AP Calc BC": { "name": "AP Calc BC", "children": [ { "name": "Derivatives" }, { "name": "Integrals" }, { "name": "Limits" } ] },
            "Derivatives": { "name": "Derivatives", "children": [ { "name": "Power Rule" }, { "name": "Product Rule" }, { "name": "Quotient Rule" }, { "name": "Chain Rule" } ] },
            "Integrals": { "name": "Integrals", "children": [ { "name": "Basic Antiderivatives" }, { "name": "U-Substitution" }, { "name": "Integration by Parts" } ] },
            "Power Rule": { "name": "Power Rule", "children": [ { "name": "Understanding Exponents" }, { "name": "Finding d/dx of x^n" } ] },
            "Limits": { "name": "Limits", "children": [ { "name": "One-Sided Limits" }, { "name": "Limits at Infinity" } ] },
            "Chain Rule": { "name": "Chain Rule", "children": [ { "name":"Composite Functions" }, { "name": "Implicit Differentiation" } ] },
            "Understanding Exponents": { "name": "Understanding Exponents", "children": [ { "name": "Integer Exponents" }, { "name": "Rational Exponents" } ] },
            "Composite Functions": { "name": "Composite Functions", "children": [ { "name": "Definition of Composite Functions" }, { "name":"Evaluating Composite Functions" } ] }
        };

        const FAKE_PROBLEM_DB = {
            "Derivatives": {
                problems: [ { q: "Find the derivative of f(x) = 5x³ + 2x - 1", s: "f'(x) = 15x² + 2" } ],
                videos: [ { title: "Introduction to Derivatives (Khan Academy)", url: "#" } ]
            },
            "Power Rule": {
                problems: [ { q: "What is the derivative of y = x⁷ ?", s: "y' = 7x⁶" }, { q: "Find f'(x) for f(x) = 4√x", s: "f'(x) = 2 / √x" } ],
                videos: [ { title: "The Power Rule (Khan Academy)", url: "#" } ]
            },
            "Understanding Exponents": {
                problems: [ { q: "Simplify x^2 * x^3", s: "x^(2+3) = x^5" }, { q: "Simplify (y^4)^2", s: "y^(4*2) = y^8" } ],
                videos: [ { title: "Laws of Exponents (Math Antics)", url: "#" } ]
            }
        };
        // --- END MOCK DATABASE ---


        // --- MODAL FUNCTIONS (Unchanged) ---
        const modalOverlay = document.getElementById('modal-overlay');
        const modalClose = document.getElementById('modal-close');
        const modalTitle = document.getElementById('modal-title');
        const problemsContainer = document.getElementById('practice-problems');
        const videosContainer = document.getElementById('video-tutorials');

        function closeModal() {
            modalOverlay.style.display = 'none';
        }

        function openModal(nodeData) {
            modalTitle.textContent = nodeData.name;
            const skillContent = FAKE_PROBLEM_DB[nodeData.name];
            
            problemsContainer.innerHTML = '<h3>Practice Problems</h3>';
            videosContainer.innerHTML = '<h3>Video Tutorials</h3>';
            
            if (skillContent && skillContent.problems && skillContent.problems.length > 0) {
                skillContent.problems.forEach(prob => {
                    const problemEl = document.createElement('div');
                    problemEl.className = 'problem';
                    problemEl.innerHTML = `<p>${prob.q}</p><div class="solution">${prob.s}</div>`;
                    problemsContainer.appendChild(problemEl);
                });
            } else {
                problemsContainer.innerHTML += '<p style="color: var(--text-secondary);">No practice problems found for this skill.</p>';
            }

            if (skillContent && skillContent.videos && skillContent.videos.length > 0) {
                 skillContent.videos.forEach(vid => {
                    const videoEl = document.createElement('a');
                    videoEl.className = 'video-link';
                    videoEl.href = vid.url;
                    videoEl.target = '_blank';
                    videoEl.textContent = `▶ ${vid.title}`;
                    videosContainer.appendChild(videoEl);
                });
            } else {
                videosContainer.innerHTML += '<p style="color: var(--text-secondary);">No videos found for this skill.</p>';
            }
           
            modalOverlay.style.display = 'flex';
        }

        // --- DATA PREP FUNCTION (Unchanged) ---
        function buildFullTree(skillName) {
            const nodeData = FAKE_SKILL_DB[skillName];
            if (!nodeData) {
                return { name: skillName, children: [] }; 
            }
            
            let newNode = { name: nodeData.name }; 
            if (nodeData.children && nodeData.children.length > 0) {
                newNode.children = nodeData.children.map(child => buildFullTree(child.name));
            } else {
                newNode.children = []; 
            }
            
            return newNode;
        }


        // --- ECHARTS IMPLEMENTATION (UPDATED LABEL ROTATION) ---
        
        const animationDuration = 500; 

        /**
         * Main ECharts function to draw the tree.
         */
        function drawEChartTree(data) {
            const treeContainer = document.getElementById('tree-container');
            
            treeContainer.innerHTML = `<p class="loading-message">Loading visualization...</p>`;
            
            setTimeout(() => {
                treeContainer.innerHTML = ''; 
                const myChart = echarts.init(treeContainer, 'dark', { renderer: 'canvas' });

                const chartOptions = {
                    backgroundColor: 'transparent', 
                    tooltip: {
                        trigger: 'item',
                        triggerOn: 'mousemove'
                    },
                    series: [
                        {
                            type: 'tree',
                            data: [data], 
                            layout: 'radial', 
                            roam: true, 
                            expandAndCollapse: true,
                            animationDuration: animationDuration, 
                            initialTreeDepth: 0, 
                            symbol: 'circle',
                            symbolSize: 10,
                            
                            label: {
                                position: 'auto', // Auto-position based on angle
                                verticalAlign: 'middle',
                                align: 'auto', // Auto-align based on angle
                                fontSize: 14,
                                color: '#f0f0f0', 
                                triggerEvent: true, 
                                
                                // === UPDATED: Keep text horizontal ===
                                rotate: 0, 
                                
                                emphasis: {
                                    color: '#ffffff', 
                                    focus: 'ancestor' 
                                }
                            },
                            
                            lineStyle: {
                                color: '#444',
                                width: 1.5,
                                curveness: 0.5 
                            },
                            
                            leaves: {
                                label: {
                                    position: 'auto',
                                    verticalAlign: 'middle',
                                    align: 'auto',
                                    color: '#f0f0f0',
                                    
                                    // === UPDATED: Keep leaf text horizontal ===
                                    rotate: 0, 
                                    
                                    emphasis: {
                                        color: '#ffffff'
                                    }
                                },
                                itemStyle: {
                                    color: 'var(--accent-primary)' 
                                }
                            },
                            
                            itemStyle: {
                                color: 'var(--icon-color-2)', 
                                borderColor: 'var(--icon-color-2)'
                            }
                        }
                    ]
                };

                myChart.setOption(chartOptions);

                // --- Click Handler (Unchanged) ---
                myChart.on('click', (params) => {
                    if (params.componentType === 'series' && params.componentSubType === 'tree') {
                        const nodeData = params.data;
                        const dataIndex = params.dataIndex;
                        const seriesIndex = params.seriesIndex;
                        
                        // Check if it's a leaf node
                        if (!nodeData.children || nodeData.children.length === 0) {
                            openModal(nodeData);
                        } else {
                            // Internal node clicked - ECharts handles expand/collapse
                            // Attempt to focus after a delay
                            setTimeout(() => {
                                myChart.dispatchAction({
                                    type: 'focusNodeAdjacency',
                                    seriesIndex: seriesIndex,
                                    dataIndex: dataIndex 
                                });
                            }, animationDuration / 3); 
                        }
                    }
                });

                // Make the chart responsive
                window.addEventListener('resize', () => {
                    myChart.resize();
                });
            }, 10); // 10ms delay
        }


        /**
         * Runs when the page loads.
         */
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const prompt = urlParams.get('prompt') || "AP Calc BC";

            document.getElementById('prompt-title').textContent = `"${prompt}"`;
            
            const initialData = buildFullTree(prompt);
            
            drawEChartTree(initialData); 

            // Set up modal listeners
            modalClose.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            });
        });

    </script>

</body>
</html>
